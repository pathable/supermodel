<!DOCTYPE html>

<html>
<head>
  <title>supermodel.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>supermodel.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>(<span class="keyword">function</span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Use exports if on the server.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> Supermodel;
  <span class="keyword">if</span> (<span class="keyword">typeof</span> exports === <span class="string">'undefined'</span>) {
    Supermodel = <span class="keyword">this</span>.Supermodel = {};
  } <span class="keyword">else</span> {
    Supermodel = exports;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Current version.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Supermodel.VERSION = <span class="string">'0.0.4'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Require Underscore, if we&#39;re on the server, and it&#39;s not already present.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> _ = <span class="keyword">this</span>._;
  <span class="keyword">if</span> (!_ &amp;&amp; (<span class="keyword">typeof</span> require !== <span class="string">'undefined'</span>)) _ = require(<span class="string">'underscore'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Require Backbone, if we&#39;re on the server, and it&#39;s not already present.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> Backbone = <span class="keyword">this</span>.Backbone;
  <span class="keyword">if</span> (!Backbone &amp;&amp; (<span class="keyword">typeof</span> require !== <span class="string">'undefined'</span>)) {
    Backbone = require(<span class="string">'backbone'</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h1>Association</h1>
<p>Track associations between models.  Associated attributes are used and
then removed during <code>parse</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> Association = <span class="keyword">function</span>(model, options) {
    <span class="keyword">this</span>.required(options, <span class="string">'name'</span>);
    _.extend(<span class="keyword">this</span>, _.pick(options, <span class="string">'name'</span>, <span class="string">'where'</span>, <span class="string">'source'</span>, <span class="string">'store'</span>));
    _.defaults(<span class="keyword">this</span>, {
      source: <span class="keyword">this</span>.name,
      store: <span class="string">'_'</span> + <span class="keyword">this</span>.name
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Store a reference to this association by name after ensuring it&#39;s
unique.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> ctor = model;
    <span class="keyword">do</span> {
      <span class="keyword">if</span> (!ctor.associations()[<span class="keyword">this</span>.name]) <span class="keyword">continue</span>;
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Association already exists: '</span> + <span class="keyword">this</span>.name);
    } <span class="keyword">while</span> (ctor = ctor.parent);
    model.associations()[<span class="keyword">this</span>.name] = <span class="keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Listen for relevant events.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (<span class="keyword">this</span>.initialize) model.all().on(<span class="string">'initialize'</span>, <span class="keyword">this</span>.initialize, <span class="keyword">this</span>);
    <span class="keyword">if</span> (<span class="keyword">this</span>.change) model.all().on(<span class="string">'change'</span>, <span class="keyword">this</span>.change, <span class="keyword">this</span>);
    <span class="keyword">if</span> (<span class="keyword">this</span>.parse) model.all().on(<span class="string">'parse'</span>, <span class="keyword">this</span>.parse, <span class="keyword">this</span>);
    <span class="keyword">if</span> (<span class="keyword">this</span>.destroy) model.all().on(<span class="string">'destroy'</span>, <span class="keyword">this</span>.destroy, <span class="keyword">this</span>);
    <span class="keyword">if</span> (<span class="keyword">this</span>.create) model.all().on(<span class="string">'add'</span>, <span class="keyword">this</span>.create, <span class="keyword">this</span>);
  };

  _.extend(Association.prototype, {</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Notify <code>model</code> of its association with <code>other</code> using the <code>inverse</code>
option.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    associate: <span class="keyword">function</span>(model, other) {
      <span class="keyword">if</span> (!<span class="keyword">this</span>.inverse) <span class="keyword">return</span>;
      model.trigger(<span class="string">'associate:'</span> + <span class="keyword">this</span>.inverse, model, other);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Notify <code>model</code> of its dissociation with <code>other</code> using the <code>inverse</code>
option.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dissociate: <span class="keyword">function</span>(model, other) {
      <span class="keyword">if</span> (!<span class="keyword">this</span>.inverse) <span class="keyword">return</span>;
      model.trigger(<span class="string">'dissociate:'</span> + <span class="keyword">this</span>.inverse, model, other);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Throw if the specified options are not provided.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    required: <span class="keyword">function</span>(options) {
      <span class="keyword">var</span> option;
      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt; arguments.length; i++) {
        <span class="keyword">if</span> (options[option = arguments[i]]) <span class="keyword">continue</span>;
        <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Option required: '</span> + option);
      }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Wrap a function in order to capture it&#39;s context, prepend it to the
arguments and call it with the current context.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    andThis: <span class="keyword">function</span>(func) {
      <span class="keyword">var</span> context = <span class="keyword">this</span>;
      <span class="keyword">return</span> <span class="keyword">function</span>() {
        <span class="keyword">return</span> func.apply(context, [<span class="keyword">this</span>].concat(_.toArray(arguments)));
      };
    }

  });</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <h2>One</h2>
<p>One side of a one-to-one or one-to-many association.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> One = <span class="keyword">function</span>(model, options) {
    <span class="keyword">this</span>.required(options, <span class="string">'inverse'</span>, <span class="string">'model'</span>);
    Association.apply(<span class="keyword">this</span>, arguments);
    _.extend(<span class="keyword">this</span>, _.pick(options, <span class="string">'inverse'</span>, <span class="string">'model'</span>, <span class="string">'id'</span>));
    _.defaults(<span class="keyword">this</span>, {
      id: <span class="keyword">this</span>.name + <span class="string">'_id'</span>
    });
    model.all()
      .on(<span class="string">'associate:'</span> + <span class="keyword">this</span>.name, <span class="keyword">this</span>.replace, <span class="keyword">this</span>)
      .on(<span class="string">'dissociate:'</span> + <span class="keyword">this</span>.name, <span class="keyword">this</span>.remove, <span class="keyword">this</span>);
  };

  _.extend(One.prototype, Association.prototype, {</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Assign the getter/setter when a model is created.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    create: <span class="keyword">function</span>(model) {
      model[<span class="keyword">this</span>.name] = _.bind(<span class="keyword">this</span>.access, <span class="keyword">this</span>, model);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Return or replace the associated model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    access: <span class="keyword">function</span>(model, other) {
      <span class="keyword">if</span> (arguments.length &lt; <span class="number">2</span>) <span class="keyword">return</span> model[<span class="keyword">this</span>.store];
      <span class="keyword">this</span>.replace(model, other);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Parse the models attributes.  If <code>source</code> isn&#39;t found use the <code>id</code>
attribute.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    initialize: <span class="keyword">function</span>(model) {
      <span class="keyword">this</span>.parse(model, model.attributes);
      <span class="keyword">var</span> id = model.get(<span class="keyword">this</span>.id);
      <span class="keyword">if</span> (id != <span class="literal">null</span>) <span class="keyword">this</span>.replace(model, id);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>If <code>source</code> is provided, use it to initialize the association after
removing it from the response object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    parse: <span class="keyword">function</span>(model, resp) {
      <span class="keyword">if</span> (!resp || !_.has(resp, <span class="keyword">this</span>.source)) <span class="keyword">return</span>;
      <span class="keyword">var</span> attrs = resp[<span class="keyword">this</span>.source];
      <span class="keyword">delete</span> resp[<span class="keyword">this</span>.source];
      <span class="keyword">this</span>.replace(model, attrs);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Update the association when the <code>id</code> attribute changes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    change: <span class="keyword">function</span>(model) {
      <span class="keyword">if</span> (!model.hasChanged(<span class="keyword">this</span>.id)) <span class="keyword">return</span>;
      <span class="keyword">this</span>.replace(model, model.get(<span class="keyword">this</span>.id));
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Remove the current association.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    remove: <span class="keyword">function</span>(model) {
      <span class="keyword">this</span>.replace(model, <span class="literal">null</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>When a model is destroyed, its association should be removed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    destroy: <span class="keyword">function</span>(model) {
      <span class="keyword">var</span> other = model[<span class="keyword">this</span>.store];
      <span class="keyword">if</span> (!other) <span class="keyword">return</span>;
      <span class="keyword">this</span>.remove(model);
      <span class="keyword">this</span>.dissociate(other, model);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Replace the current association with <code>other</code>, taking care to remove the
current association first.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    replace: <span class="keyword">function</span>(model, other) {
      <span class="keyword">var</span> id, current;

      <span class="keyword">if</span> (!model) <span class="keyword">return</span>;
      current = model[<span class="keyword">this</span>.store];</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>If <code>other</code> is a primitive, assume it&#39;s an id.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (other != <span class="literal">null</span> &amp;&amp; !_.isObject(other)) {
        id = other;
        (other = {})[<span class="keyword">this</span>.model.prototype.idAttribute] = id;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Is <code>other</code> already the current model?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (other &amp;&amp; !(other <span class="keyword">instanceof</span> Model)) other = <span class="keyword">this</span>.model.create(other);
      <span class="keyword">if</span> (current === other) <span class="keyword">return</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Tear down the current association.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (!other) model.unset(<span class="keyword">this</span>.id);
      <span class="keyword">if</span> (current) {
        <span class="keyword">delete</span> model[<span class="keyword">this</span>.store];
        <span class="keyword">this</span>.dissociate(current, model);
      }

      <span class="keyword">if</span> (!other) <span class="keyword">return</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Set up the new association.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      model.set(<span class="keyword">this</span>.id, other.id);
      model[<span class="keyword">this</span>.store] = other;
      <span class="keyword">this</span>.associate(other, model);
    }

  });</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <h1>ManyToOne</h1>
<p>The many side of a one-to-many association.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> ManyToOne = <span class="keyword">function</span>(model, options) {
    <span class="keyword">this</span>.required(options, <span class="string">'inverse'</span>, <span class="string">'collection'</span>);
    Association.apply(<span class="keyword">this</span>, arguments);
    _.extend(<span class="keyword">this</span>, _.pick(options, <span class="string">'collection'</span>, <span class="string">'inverse'</span>));
    model.all()
      .on(<span class="string">'associate:'</span> + <span class="keyword">this</span>.name, <span class="keyword">this</span>._associate, <span class="keyword">this</span>)
      .on(<span class="string">'dissociate:'</span> + <span class="keyword">this</span>.name, <span class="keyword">this</span>._dissociate, <span class="keyword">this</span>);
  };

  _.extend(ManyToOne.prototype, Association.prototype, {</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>When a model is created, instantiate the associated collection and
assign it using <code>store</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    create: <span class="keyword">function</span>(model) {
      <span class="keyword">if</span> (!model[<span class="keyword">this</span>.name]) model[<span class="keyword">this</span>.name] = _.bind(<span class="keyword">this</span>.get, <span class="keyword">this</span>, model);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Return the associated collection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    get: <span class="keyword">function</span>(model) {
      <span class="keyword">var</span> collection = model[<span class="keyword">this</span>.store];
      <span class="keyword">if</span> (collection) <span class="keyword">return</span> collection;</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Create the collection for storing the associated models.  Listen for
&quot;add&quot;, &quot;remove&quot;, and &quot;reset&quot; events and act accordingly.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      collection = model[<span class="keyword">this</span>.store] = <span class="keyword">new</span> <span class="keyword">this</span>.collection()
      .on(<span class="string">'add'</span>, <span class="keyword">this</span>.add, <span class="keyword">this</span>)
      .on(<span class="string">'remove'</span>, <span class="keyword">this</span>.remove, <span class="keyword">this</span>)
      .on(<span class="string">'reset'</span>, <span class="keyword">this</span>.reset, <span class="keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>We&#39;ll need to know what model &quot;owns&quot; this collection in order to
handle events that it triggers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      collection.owner = model;

      <span class="keyword">return</span> collection;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Use the <code>source</code> property to reset the collection with the given models
after removing it from the response object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    parse: <span class="keyword">function</span>(model, resp) {
      <span class="keyword">if</span> (!resp) <span class="keyword">return</span>;
      <span class="keyword">var</span> attrs = resp[<span class="keyword">this</span>.source];
      <span class="keyword">if</span> (!attrs) <span class="keyword">return</span>;
      <span class="keyword">delete</span> resp[<span class="keyword">this</span>.source];
      <span class="keyword">var</span> collection = <span class="keyword">this</span>.get(model);
      attrs = collection.parse(attrs);</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>If <code>where</code> is not specified, reset the collection and bail.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (!<span class="keyword">this</span>.where) {
        collection.reset(attrs);
        <span class="keyword">return</span>;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Reset the collection after filtering the models from <code>attrs</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      collection.reset(_.filter(_.map(attrs, <span class="keyword">function</span>(attrs) {
        <span class="keyword">return</span> <span class="keyword">new</span> collection.model(attrs);
      }), <span class="keyword">this</span>.where));
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Parse the attributes to initialize a new model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    initialize: <span class="keyword">function</span>(model) {
      <span class="keyword">this</span>.parse(model, model.attributes);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Models added to the collection should be associated with the owner.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    add: <span class="keyword">function</span>(model, collection) {
      <span class="keyword">if</span> (!model || !collection) <span class="keyword">return</span>;
      <span class="keyword">this</span>.associate(model, collection.owner);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Models removed from the collection should be dissociated from the owner.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    remove: <span class="keyword">function</span>(model, collection) {
      <span class="keyword">if</span> (!model || !collection) <span class="keyword">return</span>;
      <span class="keyword">this</span>.dissociate(model, collection.owner);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>After a reset, all new models should be associated with the owner.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    reset: <span class="keyword">function</span>(collection) {
      <span class="keyword">if</span> (!collection) <span class="keyword">return</span>;
      collection.each(<span class="keyword">function</span>(model) {
        <span class="keyword">this</span>.associate(model, collection.owner);
      }, <span class="keyword">this</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>If the owner is destroyed, all models in the collection should be
dissociated from it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    destroy: <span class="keyword">function</span>(model) {
      <span class="keyword">var</span> collection;
      <span class="keyword">if</span> (!model || !(collection = model[<span class="keyword">this</span>.store])) <span class="keyword">return</span>;
      collection.each(<span class="keyword">function</span>(other) {
        <span class="keyword">this</span>.dissociate(other, model);
      }, <span class="keyword">this</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Associated models should be added to the collection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _associate: <span class="keyword">function</span>(model, other) {
      <span class="keyword">if</span> (!model || !other) <span class="keyword">return</span>;
      <span class="keyword">if</span> (<span class="keyword">this</span>.where &amp;&amp; !<span class="keyword">this</span>.where(other)) <span class="keyword">return</span>;
      <span class="keyword">this</span>.get(model).add(other);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Dissociated models should be removed from the collection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _dissociate: <span class="keyword">function</span>(model, other) {
      <span class="keyword">if</span> (!model || !other || !model[<span class="keyword">this</span>.store]) <span class="keyword">return</span>;
      model[<span class="keyword">this</span>.store].remove(other);
    }

  });</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <h1>ManyToMany</h1>
<p>One side of a many-to-many association.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> ManyToMany = <span class="keyword">function</span>(model, options) {
    <span class="keyword">this</span>.required(options, <span class="string">'collection'</span>, <span class="string">'through'</span>, <span class="string">'source'</span>);
    Association.apply(<span class="keyword">this</span>, arguments);
    _.extend(<span class="keyword">this</span>, _.pick(options, <span class="string">'collection'</span>, <span class="string">'through'</span>));
    <span class="keyword">this</span>._associate = <span class="keyword">this</span>.andThis(<span class="keyword">this</span>._associate);
    <span class="keyword">this</span>._dissociate = <span class="keyword">this</span>.andThis(<span class="keyword">this</span>._dissociate);
  };

  _.extend(ManyToMany.prototype, Association.prototype, {</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>When a new model is created, assign the getter.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    create: <span class="keyword">function</span>(model) {
      <span class="keyword">if</span> (!model[<span class="keyword">this</span>.name]) model[<span class="keyword">this</span>.name] = _.bind(<span class="keyword">this</span>.get, <span class="keyword">this</span>, model);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Lazy load the associated collection to avoid initialization costs.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    get: <span class="keyword">function</span>(model) {
      <span class="keyword">var</span> collection = model[<span class="keyword">this</span>.store];
      <span class="keyword">if</span> (collection) <span class="keyword">return</span> collection;</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Create a new collection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      collection = <span class="keyword">new</span> <span class="keyword">this</span>.collection();</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>We&#39;ll need to know what model &quot;owns&quot; this collection in order to
handle events that it triggers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      collection.owner = model;
      model[<span class="keyword">this</span>.store] = collection;</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Initialize listeners and models.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">this</span>.reset(model[<span class="keyword">this</span>.through]()
        .on(<span class="string">'add'</span>, <span class="keyword">this</span>.add, <span class="keyword">this</span>)
        .on(<span class="string">'remove'</span>, <span class="keyword">this</span>.remove, <span class="keyword">this</span>)
        .on(<span class="string">'reset'</span>, <span class="keyword">this</span>.reset, <span class="keyword">this</span>)
        .on(<span class="string">'associate:'</span> + <span class="keyword">this</span>.source, <span class="keyword">this</span>._associate)
        .on(<span class="string">'dissociate:'</span> + <span class="keyword">this</span>.source, <span class="keyword">this</span>._dissociate));

      <span class="keyword">return</span> collection;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Add models to the collection when added to the through collection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    add: <span class="keyword">function</span>(model, through) {
      <span class="keyword">if</span> (!model || !through || !(model = model[<span class="keyword">this</span>.source]())) <span class="keyword">return</span>;
      <span class="keyword">if</span> (<span class="keyword">this</span>.where &amp;&amp; !<span class="keyword">this</span>.where(model)) <span class="keyword">return</span>;
      through.owner[<span class="keyword">this</span>.name]().add(model);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Remove models from the collection when removed from the through
collection after checking for other instances.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    remove: <span class="keyword">function</span>(model, through) {
      <span class="keyword">if</span> (!model || !through || !(model = model[<span class="keyword">this</span>.source]())) <span class="keyword">return</span>;
      <span class="keyword">var</span> exists = through.any(<span class="keyword">function</span>(o) {
        <span class="keyword">return</span> o[<span class="keyword">this</span>.source]() === model;
      }, <span class="keyword">this</span>);
      <span class="keyword">if</span> (!exists) through.owner[<span class="keyword">this</span>.name]().remove(model);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Reset when the through collection is reset.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    reset: <span class="keyword">function</span>(through) {
      <span class="keyword">if</span> (!through) <span class="keyword">return</span>;
      <span class="keyword">var</span> models = _.compact(_.uniq(_.invoke(through.models, <span class="keyword">this</span>.source)));
      <span class="keyword">if</span> (<span class="keyword">this</span>.where) models = _.filter(models, <span class="keyword">this</span>.where);
      through.owner[<span class="keyword">this</span>.name]().reset(models);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Add associated models.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _associate: <span class="keyword">function</span>(through, model, other) {
      <span class="keyword">if</span> (!through || !model || !other) <span class="keyword">return</span>;
      <span class="keyword">if</span> (<span class="keyword">this</span>.where &amp;&amp; !<span class="keyword">this</span>.where(other)) <span class="keyword">return</span>;
      through.owner[<span class="keyword">this</span>.name]().add(other);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Remove dissociated models, taking care to check for other instances.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _dissociate: <span class="keyword">function</span>(through, model, other) {
      <span class="keyword">if</span> (!through || !model || !other) <span class="keyword">return</span>;
      <span class="keyword">var</span> exists = through.any(<span class="keyword">function</span>(o) {
        <span class="keyword">return</span> o[<span class="keyword">this</span>.source]() === other;
      }, <span class="keyword">this</span>);
      <span class="keyword">if</span> (!exists) through.owner[<span class="keyword">this</span>.name]().remove(other);
    }

  });</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <h1>has</h1>
<p>Avoid naming collisions by providing one entry point for associations.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> Has = <span class="keyword">function</span>(model) {
    <span class="keyword">this</span>.model = model;
  };

  _.extend(Has.prototype, {</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <h2>one</h2>
<p><em>Create a one-to-one or one-to-many association.</em></p>
<p>Options:</p>
<ul>
<li><strong>inverse</strong> - (<em>required</em>) The name of the inverse association.</li>
<li><strong>model</strong> - (<em>required</em>) The model constructor for the association.</li>
<li><strong>id</strong> - The associated id is stored here.
Defaults to <code>name</code> + &#39;_id&#39;.</li>
<li><strong>source</strong> - The attribute where nested data is stored.
Defaults to <code>name</code>.</li>
<li><strong>store</strong> - The property to store the association in.
Defaults to &#39;_&#39; + <code>name</code>.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    one: <span class="keyword">function</span>(name, options) {
      options.name = name;
      <span class="keyword">new</span> One(<span class="keyword">this</span>.model, options);
      <span class="keyword">return</span> <span class="keyword">this</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <h2>many</h2>
<p><em>Create a many-to-one or many-to-many association.</em></p>
<p>Options:</p>
<ul>
<li><strong>collection</strong> - (<em>required</em>) The collection constructor.</li>
<li><strong>inverse</strong> - (<em>required for many-to-one associations</em>) The name of the
inverse association.</li>
<li><strong>through</strong> - (<em>required for many-to-many associations</em>) The name of the
through association.</li>
<li><strong>source</strong> - (<em>required for many-to-many associations</em>) For many-to-one
associations, the attribute where nested data is stored. For many-to-many
associations, the name of the indirect association.</li>
<li><strong>store</strong> - The property to store the association in.
Defaults to &#39;_&#39; + <code>name</code>.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    many: <span class="keyword">function</span>(name, options) {
      options.name = name;
      <span class="keyword">var</span> Association = options.through ? ManyToMany : ManyToOne;
      <span class="keyword">new</span> Association(<span class="keyword">this</span>.model, options);
      <span class="keyword">return</span> <span class="keyword">this</span>;
    }

  });</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <h1>Model</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> Model = Supermodel.Model = Backbone.Model.extend({</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>The attribute to store the cid in for lookup.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    cidAttribute: <span class="string">'cid'</span>,

    initialize: <span class="keyword">function</span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Use <code>&quot;cid&quot;</code> for retrieving models by <code>attributes.cid</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">this</span>.set(<span class="keyword">this</span>.cidAttribute, <span class="keyword">this</span>.cid);</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Add the model to <code>all</code> for each constructor in its prototype chain.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> ctor = <span class="keyword">this</span>.constructor;
      <span class="keyword">do</span> { ctor.all().add(<span class="keyword">this</span>); } <span class="keyword">while</span> (ctor = ctor.parent);</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Trigger &#39;initialize&#39; for listening associations.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">this</span>.trigger(<span class="string">'initialize'</span>, <span class="keyword">this</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>While <code>&quot;cid&quot;</code> is used for tracking models, it should not be persisted.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    toJSON: <span class="keyword">function</span>() {
      <span class="keyword">var</span> o = Backbone.Model.prototype.toJSON.apply(<span class="keyword">this</span>, arguments);
      <span class="keyword">delete</span> o[<span class="keyword">this</span>.cidAttribute];
      <span class="keyword">return</span> o;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Associations are initialized/updated during <code>parse</code>.  They listen for
the <code>&#39;parse&#39;</code> event and remove the appropriate properties after parsing.</p>
<p>The remaining properties are returned from <code>source</code>, if provided.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    parse: <span class="keyword">function</span>(resp) {
      <span class="keyword">this</span>.trigger(<span class="string">'parse'</span>, <span class="keyword">this</span>, resp);
      <span class="keyword">return</span> (<span class="keyword">this</span>.source &amp;&amp; resp[<span class="keyword">this</span>.source]) ? resp[<span class="keyword">this</span>.source] : resp;
    }

  }, {</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <h2>create</h2>
<p>Create a new model after checking for existence of a model with the same
id.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    create: <span class="keyword">function</span>(attrs, options) {
      <span class="keyword">var</span> model;
      <span class="keyword">var</span> all = <span class="keyword">this</span>.all();
      <span class="keyword">var</span> cid = attrs &amp;&amp; attrs[<span class="keyword">this</span>.prototype.cidAttribute];
      <span class="keyword">var</span> id = attrs &amp;&amp; attrs[<span class="keyword">this</span>.prototype.idAttribute];</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>If <code>attrs</code> belongs to an existing model, return it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (cid &amp;&amp; (model = all.getByCid(cid)) &amp;&amp; model.attributes === attrs) {
        <span class="keyword">return</span> model;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>If a model already exists for <code>id</code>, return it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (id &amp;&amp; (model = all.get(id))) {
        model.parse(attrs);
        model.set(attrs);
        <span class="keyword">return</span> model;
      }

      <span class="keyword">if</span> (!id) <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">this</span>(attrs, options);</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Throw if a model already exists with the same id in a superclass.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> ctor = <span class="keyword">this</span>;
      <span class="keyword">do</span> {
        <span class="keyword">if</span> (!ctor.all().get(id)) <span class="keyword">continue</span>;
        <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Model with id "'</span> + id + <span class="string">'" already exists.'</span>);
      } <span class="keyword">while</span> (ctor = ctor.parent);

      <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">this</span>(attrs, options);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Create associations for a model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    has: <span class="keyword">function</span>() {
      <span class="keyword">return</span> <span class="keyword">new</span> Has(<span class="keyword">this</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Return a collection of all models for a particular constructor.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    all: <span class="keyword">function</span>() {
      <span class="keyword">return</span> <span class="keyword">this</span>._all || (<span class="keyword">this</span>._all = <span class="keyword">new</span> Backbone.Collection());
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Return a hash of all associations for a particular constructor.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    associations: <span class="keyword">function</span>() {
      <span class="keyword">return</span> <span class="keyword">this</span>._associations || (<span class="keyword">this</span>._associations = {});
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Models and associations are tracked via <code>all</code> and <code>associations</code>,
respectively.  <code>reset</code> removes all model references to allow garbage
collection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    reset: <span class="keyword">function</span>() {
      <span class="keyword">this</span>._all = <span class="keyword">new</span> Backbone.Collection();
      <span class="keyword">this</span>._associations = {};
    }

  });

}).call(<span class="keyword">this</span>);</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
